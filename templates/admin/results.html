{% extends 'base.html' %}

{% block title %}Results – {{ election.title }}{% endblock %}

{% block charts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
{% endblock %}

{% block extra_css %}
<style>
    .chart-container { position: relative; height: 300px; }
    .vote-count { font-size: 1.75rem; font-weight: 600; color: var(--accent); }
    .percentage { font-size: 0.875rem; color: var(--text-secondary); }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">Results</h1>
        <p class="text-secondary small mb-0">{{ election.title }}</p>
    </div>
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary btn-sm">← Dashboard</a>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="small text-secondary">Status</div>
                <span class="status-badge status-{{ election.status }}">{{ election.status|capitalize }}</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="small text-secondary">Start</div>
                <div>{{ election.start_date.strftime('%b %d, %Y %H:%M') }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="small text-secondary">End</div>
                <div>{{ election.end_date.strftime('%b %d, %Y %H:%M') }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="small text-secondary">Total Votes</div>
                <div class="vote-count">{{ total_votes }}</div>
            </div>
        </div>
    </div>
</div>

{% if results %}
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Bar Chart</div>
            <div class="card-body">
                <div class="chart-container"><canvas id="barChart"></canvas></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Distribution</div>
            <div class="card-body">
                <div class="chart-container"><canvas id="pieChart"></canvas></div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Candidates</div>
    <div class="card-body">
        <div class="row g-3">
            {% for result in results %}
            <div class="col-md-6">
                <div class="d-flex justify-content-between align-items-center p-3" style="background: var(--bg-secondary); border-radius: 8px;">
                    <div>
                        <strong>{{ result.name }}</strong>
                        {% if result.party %}<span class="text-secondary small d-block">{{ result.party }}</span>{% endif %}
                    </div>
                    <div class="text-end">
                        <div class="vote-count">{{ result.votes }}</div>
                        <div class="percentage">
                            {% if total_votes > 0 %}{{ "%.1f"|format((result.votes / total_votes * 100)) }}%{% else %}0%{% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body text-center py-5 text-muted">No votes cast yet.</div>
</div>
{% endif %}

{% if detailed_votes %}
<div class="card">
    <div class="card-header">Vote Records</div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Voter ID</th>
                        <th>Name</th>
                        <th>Voted For</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vote in detailed_votes %}
                    <tr>
                        <td><code class="small">{{ vote.voter_id }}</code></td>
                        <td>{{ vote.voter_name }}</td>
                        <td><strong>{{ vote.candidate_name }}</strong></td>
                        <td class="text-secondary">{{ vote.timestamp.strftime('%b %d, %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    const resultsData = {{ results|tojson }};
    const labels = resultsData.map(r => r.name);
    const votes = resultsData.map(r => r.votes);
    
    const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#0ea5e9', '#22c55e'];
    
    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{ label: 'Votes', data: votes, backgroundColor: colors.slice(0, labels.length), borderWidth: 0, borderRadius: 4 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }}, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 }}}}
    });
    
    new Chart(document.getElementById('pieChart'), {
        type: 'doughnut',
        data: { labels: labels, datasets: [{ data: votes, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }}}
    });
    
    {% if election.status == 'active' %}
    setInterval(() => location.reload(), 15000);
    {% endif %}
</script>
{% endblock %}
