{% extends 'admin/base_admin.html' %}

{% block title %}Results â€“ {{ election.title }}{% endblock %}

{% block charts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
{% endblock %}

{% block extra_css %}
<style>
    .chart-container { position: relative; height: 320px; }
    .vote-count { font-size: 2rem; font-weight: 700; color: var(--primary); }
    .percentage { font-size: 0.875rem; color: var(--gray-500); }
    .result-card { 
        background: var(--gray-50); 
        border-radius: var(--radius-md); 
        padding: 1.25rem;
        border-left: 4px solid var(--primary);
    }
    .result-card:nth-child(2n) { border-left-color: var(--accent); }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Election Results</h1>
    <p class="page-subtitle">{{ election.title }}</p>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: var(--primary);">
            <div class="stat-label">Status</div>
            <span class="status-badge status-{{ election.status }}">{{ election.status|capitalize }}</span>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: var(--accent);">
            <div class="stat-label">Start Date</div>
            <div class="stat-value" style="font-size: 1rem;">{{ election.start_date.strftime('%b %d, %Y %H:%M') }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #f59e0b;">
            <div class="stat-label">End Date</div>
            <div class="stat-value" style="font-size: 1rem;">{{ election.end_date.strftime('%b %d, %Y %H:%M') }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #8b5cf6;">
            <div class="stat-label">Total Votes</div>
            <div class="stat-value">{{ total_votes }}</div>
        </div>
    </div>
</div>

{% if results %}
<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>Vote Distribution
            </div>
            <div class="card-body">
                <div class="chart-container"><canvas id="barChart"></canvas></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i>Vote Share
            </div>
            <div class="card-body">
                <div class="chart-container"><canvas id="pieChart"></canvas></div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-users me-2"></i>Candidate Results
    </div>
    <div class="card-body">
        <div class="row g-3">
            {% for result in results %}
            <div class="col-md-6">
                <div class="result-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ result.name }}</strong>
                            {% if result.party %}<span class="text-muted small d-block">{{ result.party }}</span>{% endif %}
                        </div>
                        <div class="text-end">
                            <div class="vote-count">{{ result.votes }}</div>
                            <div class="percentage">
                                {% if total_votes > 0 %}{{ "%.1f"|format((result.votes / total_votes * 100)) }}%{% else %}0%{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% else %}
<div class="empty-state">
    <i class="fas fa-chart-bar"></i>
    <p>No votes have been cast yet</p>
</div>
{% endif %}

{% if detailed_votes %}
<div class="card">
    <div class="card-header">
        <i class="fas fa-list me-2"></i>Vote Records
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Voter ID</th>
                        <th>Name</th>
                        <th>Voted For</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vote in detailed_votes %}
                    <tr>
                        <td><code class="small">{{ vote.voter_id }}</code></td>
                        <td>{{ vote.voter_name }}</td>
                        <td><strong>{{ vote.candidate_name }}</strong></td>
                        <td class="text-muted">{{ vote.timestamp.strftime('%b %d, %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    const resultsData = {{ results|tojson }};
    const labels = resultsData.map(r => r.name);
    const votes = resultsData.map(r => r.votes);
    
    const colors = ['#1e3a8a', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#0ea5e9', '#22c55e'];
    
    Chart.defaults.font.family = "'Inter', -apple-system, sans-serif";
    
    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{ 
                label: 'Votes', 
                data: votes, 
                backgroundColor: colors.slice(0, labels.length), 
                borderWidth: 0, 
                borderRadius: 6,
                barPercentage: 0.7
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { legend: { display: false }}, 
            scales: { 
                y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: '#e5e7eb' }},
                x: { grid: { display: false }}
            }
        }
    });
    
    new Chart(document.getElementById('pieChart'), {
        type: 'doughnut',
        data: { 
            labels: labels, 
            datasets: [{ 
                data: votes, 
                backgroundColor: colors.slice(0, labels.length), 
                borderWidth: 2,
                borderColor: '#fff'
            }] 
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            cutout: '55%',
            plugins: { legend: { position: 'right', labels: { padding: 16, usePointStyle: true }}}
        }
    });
    
    {% if election.status == 'active' %}
    setInterval(() => location.reload(), 15000);
    {% endif %}
</script>
{% endblock %}
